@page "/lobby/{LobbyId}"
@using Microsoft.AspNetCore.SignalR.Client
@using AZ_Inz.Classes
@using AZ_Inz.Classes.DTO
@using AZ_Inz.Classes.ViewModel
@inject NavigationManager Navigation
@inject CustomAuthStateProvider AuthStateProvider
@inject HttpClient Http
@inject IJSRuntime JS


<h2>Lobby ID: @LobbyId</h2>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
        <p style="color:red;">@ErrorMessage</p>
}

@if (hubConnection is null || hubConnection.State != HubConnectionState.Connected)
{
        <p>Connecting to the lobby...</p>
}
else
{
        <h3>Players in Lobby</h3>
        <ul>
        @foreach (var player in Players)
        {
                    <li>@player.Nickname</li>
        }
        </ul>

    @if (IsHost)
    {
                <h3>Lobby Settings (Host Only)</h3>

                <div>
                    <label>Score to Win: </label>
                    <input type="number" @bind="ScoreToWin" />
                </div>

                <h4>Answer Decks</h4>
        @if (AllAnswerDecks is null)
        {
                        <p>Loading answer decks...</p>
        }
        else
        {
            @foreach (var deck in AllAnswerDecks)
            {
                                <div>
                                    <input type="checkbox"
                                           @bind="deck.IsSelected" />
                                    <label>@deck.Name</label>
                                </div>
            }
        }

                <h4>Question Decks</h4>
        @if (AllQuestionDecks is null)
        {
                        <p>Loading question decks...</p>
        }
        else
        {
            @foreach (var deck in AllQuestionDecks)
            {
                                <div>
                                    <input type="checkbox"
                                           @bind="deck.IsSelected" />
                                    <label>@deck.Name</label>
                                </div>
            }
        }
                <button @onclick="StartGame">Start Game</button>
    }
    else
    {
                <p>Waiting for the host to select decks and start the game...</p>
    }
}

@code {
    [Parameter] public string LobbyId { get; set; }

    private bool isLoading = true;
    private HubConnection hubConnection;
    private string ErrorMessage;

    private List<Player> Players = new();
    private bool IsHost = false;
    private string myNickname;

    private int ScoreToWin;
    private List<AnswerDeckViewModel> AllAnswerDecks;
    private List<QuestionDeckViewModel> AllQuestionDecks;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            //Get nickname from cookie or from auth
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity.IsAuthenticated)
            {
                myNickname = authState.User.Identity.Name;
            }
            else
            {
                myNickname = await JS.InvokeAsync<string>("cookieManager.getCookie", "nickname");
            }

            //SignalR hub connection
            hubConnection = new HubConnectionBuilder()
                .WithUrl("https://localhost:7060/lobbyhub")
                .WithAutomaticReconnect()
                .Build();

            //Hub events
            hubConnection.On<Player>("PlayerJoined", OnPlayerJoined);
            hubConnection.On<string>("GameplayRedirection", OnGameplayRedirection);

            await hubConnection.StartAsync();

            //Fetch the lobby details
            LobbyInfoDTO lobby = await hubConnection.InvokeAsync<LobbyInfoDTO>("GetLobbyDetails", LobbyId);
            if (lobby == null)
            {
                ErrorMessage = "Lobby not found.";
                return;
            }

            Players = lobby.Players;
            IsHost = (myNickname == lobby.HostNickname);

            await LoadAllDecks();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
        }
    }

    public void OnPlayerJoined(Player player)
    {
        Players.Add(player);
        //Console.WriteLine("OnPlayerJoined triggered with data: " + player.Nickname);

        StateHasChanged();
    }

    private async Task LoadAllDecks()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<AvailableDecksDTO>("https://localhost:7060/api/Decks/all-decks");
            AllAnswerDecks = response.AnswerDecks
                .Select(ad => new AnswerDeckViewModel { Id = ad.Id, Name = ad.Name })
                .ToList();

            AllQuestionDecks = response.QuestionDecks
                .Select(qd => new QuestionDeckViewModel { Id = qd.Id, Name = qd.Name })
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Failed to load decks: " + ex.Message);
        }
    }

    private async Task StartGame()
    {
        try
        {
            var chosenAnswerDeckIds = AllAnswerDecks
                .Where(d => d.IsSelected)
                .Select(d => d.Id)
                .ToList();

            var chosenQuestionDeckIds = AllQuestionDecks
                .Where(d => d.IsSelected)
                .Select(d => d.Id)
                .ToList();

            GameInfoDTO gameInfo = new()
            {
                lobbyID = LobbyId,
                ScoreToWin = ScoreToWin,
                ChosenAnswersDecks = chosenAnswerDeckIds,
                ChosenQuestionsDecks = chosenQuestionDeckIds
            };

            Console.WriteLine("Starting the game");
            await hubConnection.SendAsync("StartGame", gameInfo);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Could not save lobby options: {ex.Message}";
        }
    }

    private async Task OnGameplayRedirection(string gameId)
    {
            Navigation.NavigateTo($"/game/{gameId}");
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
